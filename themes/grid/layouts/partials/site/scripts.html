{{ $app := resources.Get "js/app.js" }}
{{ $lazymain := resources.Get "js/vendor/lazysizes.js" }}
{{ $lsar := resources.Get "js/vendor/ls.aspectratio.js" }}

{{ $js := slice $app $lazymain $lsar | resources.Concat "js/bundle.js" | minify | fingerprint "sha512" }}

{{ $pswpMain := resources.Get "js/vendor/photoswipe-4.1.3/photoswipe.js" }}
{{ $pswpUI := resources.Get "js/vendor/photoswipe-4.1.3/photoswipe-ui-default.js" }}
{{ $pswp := slice $pswpMain $pswpUI | resources.Concat "js/pswp.js" | minify | fingerprint "sha512" }}

<script type="text/javascript" src="{{ $js.Permalink }}" integrity="{{ $js.Data.Integrity }}"></script>
{{ if and (eq .Kind "page") (eq .Type "gallery") (eq .Params.contentType "album" ) }}
  <script type="text/javascript" src="{{ $pswp.Permalink }}" integrity="{{ $pswp.Data.Integrity }}"></script>
  <script type="text/javascript">
    function initPhotoSwipefromDOM (gallerySelector, photoList) {

    var closest = function closest(el, fn) {
      return el && ( fn(el) ? el : closest(el.parentNode, fn) );
    }
    
    const onThumbnailsClick = function (e) {
        e = e || window.event
        e.preventDefault ? e.preventDefault() : e.returnValue = false
        
        const eTarget = e.target || e.srcElement

        var clickedListItem = closest(eTarget, function(el) {
          return (el.getAttribute('data-pswp-uid'))
        })

        if(!clickedListItem) {
            return
        }
        const index = clickedListItem.getAttribute('data-pswp-uid') - 1
        openPhotoSwipe(index, photoList)
      }

      const galleryElements = document.querySelectorAll( gallerySelector )
      
      for (let i=0; i< galleryElements.length; i++) {
        galleryElements[i].setAttribute('data-pswp-uid', i+1)
        galleryElements[i].onclick = onThumbnailsClick
      }
    }

    const openPhotoSwipe = function (index, photoList) {
      var pswpElement = document.querySelectorAll('.pswp')[0]

      let items = []
      for (let i=0; i<photoList.length; i++) {
        let el = photoList[i]
        const date = new Date(el.updatedAt)
        const version = Math.round(date.getTime() / 1000)
        items.push({
          src: 'https://{{ $.Site.Params.cacheDomain }}/' + el.file.key + '/' + version.toString() + '/src/' + el.slug + '.jpg',
          w: el.width,
          h: el.height
        })
      }
      // define options (if needed)
      var options = {
        preload: [2,5],
        barsSize: {top:0, bottom:'auto'},
        // optionName: 'option value'
        // for example:
        getThumbBoundsFn: function(index) {
          var thumbnail = document.querySelectorAll("[data-pswp-uid='"+(index+1)+"']")[0]
          console.log(thumbnail)
          pageYScroll = window.pageYOffset || document.documentElement.scrollTop,
          rect = thumbnail.getBoundingClientRect();
          return {x:rect.left, y:rect.top + pageYScroll, w:rect.width};
        },
        index: index // start at first slide
      }

      // Initializes and opens PhotoSwipe
      var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, options)
      gallery.init()
    }

    function loadJSON () {
      var xhttp = new XMLHttpRequest()
      xhttp.onreadystatechange = function () {
        if (this.readyState === 4 && this.status === 200) {
          const data = JSON.parse(this.responseText)
          data.pop()
          initPhotoSwipefromDOM('.photo-grid-item', data)
        }
      }
      xhttp.open('GET', 'index.json', true)
      xhttp.send()
    }
    loadJSON()
  </script>
{{ end }}
